<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Staqueue</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta http-equiv="x-ua-compatible" content="IE=edge" />
    <style>
      :root {
        color-scheme: dark;
      }
      html,
      body {
        height: 100%;
        margin: 0;
        background: #0b0f14;
        color: #e6e6e6;
        font-family: system-ui, Segoe UI, Roboto, Arial, sans-serif;
      }
      #status {
        position: fixed;
        inset: auto 0 12px 0;
        text-align: center;
        opacity: 0.8;
        font-size: 0.95rem;
      }
      #container {
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      #error {
        display: none;
        max-width: 900px;
        margin: 24px auto;
        background: #1b2230;
        border: 1px solid #2a3446;
        border-radius: 14px;
        padding: 16px 18px;
      }
      code,
      .mono {
        font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      }
      a {
        color: #7eb6ff;
      }
    </style>

    <!-- reduce CheerpJ console noise; must be set BEFORE the loader -->
    <script>
      window.CJ_LOG_LEVEL = "error";
    </script>
    <!-- CheerpJ 4.2 loader -->
    <script src="https://cjrtnc.leaningtech.com/4.2/loader.js"></script>
  </head>
  <body>
    <div id="container"></div>
    <div id="status">Loading Java runtime…</div>
    <div id="error"></div>

    <script>
      // Helpers
      const $ = (s) => document.querySelector(s);
      const setStatus = (msg) => {
        $("#status").textContent = msg;
      };
      function showError(title, details) {
        const box = $("#error");
        box.style.display = "block";
        box.innerHTML = `
        <div style="font-weight:600;margin-bottom:6px;">${title}</div>
        <div class="mono" style="white-space:pre-wrap">${details || ""}</div>
        <div style="margin-top:10px; opacity:.85">
          Try:
          <ul style="margin:6px 0 0 18px; line-height:1.5">
            <li>Hard refresh <span class="mono">(Ctrl/Cmd + Shift + R)</span></li>
            <li>Disable ad/script blockers for this page</li>
            <li>Ensure <span class="mono">https://cjrtnc.leaningtech.com</span> isn’t blocked</li>
            <li>Stay online — first load fetches a few MB</li>
          </ul>
        </div>`;
        setStatus("Failed to load.");
      }

      // Extra safety: verify the loader actually defined the API
      function ensureCheerpJ() {
        if (typeof window.cheerpjInit !== "function") {
          throw new Error("CheerpJ loaded but cheerpjInit is undefined");
        }
      }

      async function boot() {
        try {
          setStatus("Initializing Java runtime…");
          ensureCheerpJ();
          await window.cheerpjInit({ version: 8 });

          setStatus("Starting Swing UI…");
          await window.cheerpjCreateDisplay(
            window.innerWidth,
            window.innerHeight,
            document.getElementById("container") // mount here
          );
          // keep canvas sized to the viewport
          window.addEventListener("resize", () => {
            const canvas = document.querySelector("canvas");
            if (canvas) {
              canvas.width = window.innerWidth;
              canvas.height = window.innerHeight;
            }
          });

          // IMPORTANT: classpath must be an ARRAY; files at site root are under /app/
          await window.cheerpjRunMain("com.staqueue.App", "/app/app.jar");

          setStatus(""); // clear once UI is up
        } catch (err) {
          console.error(err);
          showError(
            "Could not start the app.",
            String((err && err.stack) || err)
          );
        }
      }
      boot();
    </script>
  </body>
</html>
